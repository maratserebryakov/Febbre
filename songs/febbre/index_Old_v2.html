<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FEBBRE ‚Äî –£—á–∏–º –ø–µ—Ä–µ–≤–æ–¥ –ø–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞–º (MP4)</title>

  <style>
    :root { color-scheme: dark; }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 18px;
      background:#0f0f12;
      color:#eaeaf0;
    }

    h1 { margin: 0 0 6px; color:#c084fc; font-size: 22px; }
    .hint { margin: 0 0 14px; color:#a1a1aa; line-height: 1.35; }

    .layout { display: grid; grid-template-columns: 1.1fr 1fr; gap: 14px; align-items: start; }
    @media (max-width: 980px){ .layout{ grid-template-columns: 1fr; } }

    .panel { background:#15151b; border:1px solid #2a2a35; border-radius: 14px; padding: 12px; }
    .playerWrap { position: sticky; top: 10px; }
    @media (max-width: 980px){ .playerWrap{ position: static; } }

    video { width: 100%; border-radius: 12px; background:#000; }

    .videoDock { position: relative; border-radius: 12px; }
    .videoDockSentinel { height: 0px; }

    @media (max-width: 980px) and (orientation: portrait) {
      .videoDock.isDocked {
        position: fixed;
        top: 0; left: 0; right: 0;
        z-index: 120;
        background: #15151b;
        border-bottom: 1px solid #2a2a35;
        padding: 10px 18px;
        box-sizing: border-box;
      }
      .videoDock.isDocked video {
        width: 100%;
        height: auto;
        max-height: 46vh;
        object-fit: contain;
      }
    }

    /* mobile landscape: 2 –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö —Å–∫—Ä–æ–ª–ª–∞ */
    @media (max-width: 980px) and (orientation: landscape) {
      body{
        margin: 0;
        padding: 10px;
        height: 100vh;
        overflow: hidden;
        box-sizing: border-box;
      }

      .layout{
        grid-template-columns: 0.95fr 1.45fr;
        height: 100%;
      }

      .panel{
        height: 100%;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
      }

      .playerWrap{ position: static; top: auto; }

      .videoDock{
        position: sticky;
        top: 0;
        z-index: 10;
        background:#15151b;
        padding-top: 0;
      }

      /* –®–∞–ø–∫–∞ –≤ —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ —Å—Ö–ª–æ–ø—ã–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ —Å–∫—Ä–æ–ª–ª—è—Ç —Ñ—Ä–∞–∑—ã */
      #pageHeader{
        overflow: hidden;
        max-height: 240px;
        opacity: 1;
        transform: translateY(0);
        transition: max-height 180ms ease, opacity 180ms ease, transform 180ms ease;
        will-change: max-height, opacity, transform;
      }
      body.isFocusMode #pageHeader{
        max-height: 0;
        opacity: 0;
        transform: translateY(-10px);
        margin: 0;
        padding: 0;
        pointer-events: none;
      }
    }

    .row{
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      padding: 12px;
      border-radius: 12px;
      background:#111118;
      border:1px solid #242432;
      margin-bottom: 10px;
    }
    .it{ font-size: 16px; }
    .ru{ display:none; color:#a1a1aa; }

    .controls{ display:flex; flex-wrap: wrap; gap:8px; align-items:center; }

    button{
      border: 0;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      background:#2d2d3a;
      color:#eaeaf0;
    }
    button:hover{ filter: brightness(1.07); }

    .primary{ background:#7c3aed; }
    .good{ background:#10b981; color:#071b12; }
    .warn{ background:#f59e0b; color:#1a1204; }
    .bad{ background:#ef4444; color:#1f0505; }
    .ghost{ background: transparent; border:1px solid #2a2a35; }

    input[type="number"], textarea{
      background:#0f0f12;
      color:#eaeaf0;
      border:1px solid #2a2a35;
      border-radius: 10px;
      padding: 8px 10px;
    }
    input[type="number"]{ width: 96px; }
    textarea{ width: 100%; min-height: 110px; resize: vertical; }

    .mini{ font-size: 12px; color:#a1a1aa; }
    .topbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom: 10px; }

    .chip{
      display:flex; gap:8px; align-items:center;
      padding: 10px;
      border:1px solid #2a2a35;
      border-radius: 12px;
      background:#111118;
    }

    .sep{ height:1px; background:#2a2a35; margin: 12px 0; }

    .muted{ opacity:.6; }
    .highlight{ box-shadow: 0 0 0 2px #f59e0b inset; }
    .warnText{ color:#f59e0b; font-weight:600; }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 980px){ .grid2{ grid-template-columns: 1fr; } }

    .mixerLamp{
      width: 26px; height: 26px;
      border-radius: 50%;
      display:inline-flex; align-items:center; justify-content:center;
      border: 1px solid #2a2a35;
      background:
        radial-gradient(closest-side, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.00) 62%),
        radial-gradient(closest-side, #14141b 0%, #0b0b10 72%, #050509 100%);
      box-shadow:
        inset 0 2px 6px rgba(0,0,0,0.65),
        inset 0 -2px 6px rgba(255,255,255,0.04),
        0 0 0 1px rgba(0,0,0,0.35);
      flex: 0 0 auto;
    }
    .mixerLamp__led{
      width:12px; height:12px;
      border-radius:50%;
      background:#2a2a35;
      box-shadow:
        inset 0 1px 2px rgba(255,255,255,0.15),
        inset 0 -2px 4px rgba(0,0,0,0.55);
    }
    .mixerLamp.is-red .mixerLamp__led{
      background: radial-gradient(circle at 35% 35%, #ffd1d1 0%, #ff3b3b 25%, #b40000 70%, #5a0000 100%);
      box-shadow: 0 0 8px rgba(255,48,48,0.85), 0 0 16px rgba(255,48,48,0.45),
        inset 0 1px 2px rgba(255,255,255,0.22), inset 0 -2px 5px rgba(0,0,0,0.55);
    }
    .mixerLamp.is-green .mixerLamp__led{
      background: radial-gradient(circle at 35% 35%, #d7ffe8 0%, #2cff7a 25%, #0a8a3b 70%, #05461f 100%);
      box-shadow: 0 0 8px rgba(44,255,122,0.85), 0 0 16px rgba(44,255,122,0.45),
        inset 0 1px 2px rgba(255,255,255,0.22), inset 0 -2px 5px rgba(0,0,0,0.55);
    }
    .mixerLamp.is-gray .mixerLamp__led{
      background: radial-gradient(circle at 35% 35%, #ffffff22 0%, #a1a1aa55 30%, #3a3a4566 80%, #101018 100%);
      box-shadow: inset 0 1px 2px rgba(255,255,255,0.10), inset 0 -2px 5px rgba(0,0,0,0.55);
    }
  </style>
</head>

<body>
  <div id="pageHeader">
    <h1>üéµ FEBBRE ‚Äî —É—á–∏–º –ø–µ—Ä–µ–≤–æ–¥ –ø–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞–º (–ª–æ–∫–∞–ª—å–Ω—ã–π MP4)</h1>
    <p class="hint">
      –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç: –ø–æ–ª–æ–∂–∏ MP4 —Ä—è–¥–æ–º —Å —ç—Ç–∏–º —Ñ–∞–π–ª–æ–º –∏ –Ω–∞–∑–æ–≤–∏ <b>febbre.mp4</b> ‚Äî –≤–∏–¥–µ–æ –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
      –ò–ª–∏ –Ω–∞–∂–º–∏ ¬´–í—ã–±—Ä–∞—Ç—å MP4¬ª. –¢–∞–π–º–∫–æ–¥—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ï—Å—Ç—å —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç JSON.
      <br><span class="mini">–í–∞–∂–Ω–æ: –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–∞–π–º–∫–æ–¥—ã/—Ñ–æ–Ω–µ—Ç–∏–∫–∞ –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –∏–∑ <b>data/songs/febbre.json</b> (–∏–ª–∏ –∏–∑ <b>febbre.json</b> —Ä—è–¥–æ–º, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å).</span>
    </p>
  </div>

  <div class="layout">
    <div class="panel playerWrap">
      <div class="topbar">
        <div class="chip"><b>–§–∞–π–ª:</b> <span id="fileLabel">febbre.mp4 (–µ—Å–ª–∏ —Ä—è–¥–æ–º)</span></div>

        <div class="chip">
          <b>–ò—Å—Ç–æ—á–Ω–∏–∫:</b>
          <span id="srcLabel">—Å–µ—Ä–≤–µ—Ä (–∏–Ω—Ç–µ—Ä–Ω–µ—Ç)</span>
          <span class="mixerLamp is-red" id="srcLamp" title="–ò—Å—Ç–æ—á–Ω–∏–∫ —Ñ–∞–π–ª–∞">
            <span class="mixerLamp__led"></span>
          </span>
        </div>

        <div class="chip"><b>–¢–µ–∫—É—â–µ–µ:</b> <span id="now">0.00</span>s</div>
        <button class="ghost" id="copyNow">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ</button>
      </div>

      <div class="topbar">
        <input id="filePick" type="file" accept="video/mp4,audio/mp4,video/*,audio/*" />
        <button class="ghost" id="useDefault">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å febbre.mp4</button>

        <button class="ghost" id="downloadBtn">–°–∫–∞—á–∞—Ç—å</button>
        <span class="mini" id="downloadHint">–§–∞–π–ª –º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å —Å –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–∞</span>

        <button class="bad" id="stop">–°—Ç–æ–ø ‚è∏</button>
      </div>

      <div id="videoDockSentinel" class="videoDockSentinel" aria-hidden="true"></div>
      <div id="videoDock" class="videoDock">
        <video id="vid" controls preload="metadata">
          <source id="defaultSrc" src="febbre.mp4" type="video/mp4" />
          –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç HTML5 video.
        </video>
      </div>

      <div class="sep"></div>

      <div class="topbar">
        <button class="primary" id="saveAll">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
        <button class="ghost" id="toggleRuAll">–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã</button>
        <button class="ghost" id="toggleLearned">–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –≤—ã—É—á–µ–Ω–Ω—ã–µ</button>
        <button class="bad" id="resetTimes">–°–±—Ä–æ—Å–∏—Ç—å —Ç–∞–π–º–∫–æ–¥—ã</button>
      </div>

      <div class="grid2">
        <div>
          <div class="mini" style="margin-bottom:6px;">–≠–∫—Å–ø–æ—Ä—Ç —Ç–∞–π–º–∫–æ–¥–æ–≤ (—Å–∫–æ–ø–∏—Ä—É–π –∫—É–¥–∞-–Ω–∏–±—É–¥—å):</div>
          <textarea id="exportBox" placeholder="–ù–∞–∂–º–∏ ¬´–≠–∫—Å–ø–æ—Ä—Ç¬ª, –ø–æ—è–≤–∏—Ç—Å—è JSON‚Ä¶"></textarea>
          <div class="topbar" style="margin-top:8px;">
            <button class="ghost" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
            <button class="ghost" id="copyExport">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON</button>
          </div>
        </div>
        <div>
          <div class="mini" style="margin-bottom:6px;">–ò–º–ø–æ—Ä—Ç —Ç–∞–π–º–∫–æ–¥–æ–≤ (–≤—Å—Ç–∞–≤—å JSON –∏ –Ω–∞–∂–º–∏ ¬´–ò–º–ø–æ—Ä—Ç¬ª):</div>
          <textarea id="importBox" placeholder='–í—Å—Ç–∞–≤—å JSON —Å—é–¥–∞‚Ä¶'></textarea>
          <div class="topbar" style="margin-top:8px;">
            <input id="jsonPick" type="file" accept="application/json,.json" />
            <button class="ghost" id="importBtn">–ò–º–ø–æ—Ä—Ç</button>
          </div>
        </div>
      </div>

      <div class="mini">
        –°–æ–≤–µ—Ç: start –º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å –Ω–∞ 0.10‚Äì0.25 —Å–µ–∫ —Ä–∞–Ω—å—à–µ –Ω–∞—á–∞–ª–∞ —Ñ—Ä–∞–∑—ã, end ‚Äî –Ω–∞ 0.10‚Äì0.25 —Å–µ–∫ –ø–æ–∑–∂–µ.
        –§–æ—Ä–º–∞—Ç ‚Äî —Å–µ–∫—É–Ω–¥—ã (–º–æ–∂–Ω–æ –¥—Ä–æ–±–Ω—ã–µ: 42.35).
      </div>
    </div>

    <div class="panel" id="phrasesPanel">
      <div id="rows"></div>
    </div>
  </div>

<script>
  const LINES = [
    { it: 'Ti sei preso una parte di me', ru: '–¢—ã –∑–∞–±—Ä–∞–ª —á–∞—Å—Ç—å –º–µ–Ω—è' },
    { it: 'Quella ancora pi√π in fondo dell‚Äôanima', ru: '–¢—É, —á—Ç–æ –µ—â—ë –≥–ª—É–±–∂–µ –≤ –¥—É—à–µ' },
    { it: 'Un sentimento', ru: '–ß—É–≤—Å—Ç–≤–æ' },
    { it: 'Che se si rompe taglia', ru: '–ö–æ—Ç–æ—Ä–æ–µ, –µ—Å–ª–∏ –ª–æ–º–∞–µ—Ç—Å—è, —Ä–µ–∂–µ—Ç' },
    { it: 'Come il vetro', ru: '–ö–∞–∫ —Å—Ç–µ–∫–ª–æ' },
    { it: 'E anche deludere', ru: '–ò –¥–∞–∂–µ —Ä–∞–∑–æ—á–∞—Ä–æ–≤—ã–≤–∞—Ç—å' },
    { it: '√à un‚Äôabitudine', ru: '–≠—Ç–æ –ø—Ä–∏–≤—ã—á–∫–∞' },
    { it: 'Come nel mio primo giorno di scuola', ru: '–ö–∞–∫ –≤ –º–æ–π –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –≤ —à–∫–æ–ª–µ' },
    { it: 'Non so che faccio qui', ru: '–Ø –Ω–µ –∑–Ω–∞—é, —á—Ç–æ –¥–µ–ª–∞—é –∑–¥–µ—Å—å' },
    { it: 'Il buio √® tagliato dalle luci viola', ru: '–¢–µ–º–Ω–æ—Ç–∞ —Ä–∞–∑—Ä–µ–∑–∞–Ω–∞ —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–º–∏ –æ–≥–Ω—è–º–∏' },
    { it: 'Il cielo fa come un glitch', ru: '–ù–µ–±–æ –±—É–¥—Ç–æ –≥–ª—é—á–∏—Ç' },
    { it: 'Tu mi guardi dall‚Äôalto', ru: '–¢—ã —Å–º–æ—Ç—Ä–∏—à—å –Ω–∞ –º–µ–Ω—è —Å–≤–µ—Ä—Ö—É' },
    { it: 'Trascinandomi in basso', ru: '–£—Ç–∞—Å–∫–∏–≤–∞—è –º–µ–Ω—è –≤–Ω–∏–∑' },
    { it: 'Non ascolti quando grido', ru: '–¢—ã –Ω–µ —Å–ª—ã—à–∏—à—å, –∫–æ–≥–¥–∞ —è –∫—Ä–∏—á—É' },
    { it: 'Sembri fatto di ghiaccio', ru: '–¢—ã –±—É–¥—Ç–æ —Å–¥–µ–ª–∞–Ω –∏–∑–æ –ª—å–¥–∞' },
    { it: 'Io sono fatta cos√¨', ru: '–Ø —Ç–∞–∫–∞—è' },
    { it: 'Alle feste chic', ru: '–ù–∞ –≥–ª–∞–º—É—Ä–Ω—ã—Ö –≤–µ—á–µ—Ä–∏–Ω–∫–∞—Ö' },
    { it: 'Sola su un terrazzo', ru: '–û–¥–Ω–∞ –Ω–∞ —Ç–µ—Ä—Ä–∞—Å–µ' },
    { it: 'Tutti fanno bling bling', ru: '–í—Å–µ —Å–≤–µ—Ä–∫–∞—é—Ç' },
    { it: 'Io nemmeno mi piaccio', ru: '–ú–Ω–µ –¥–∞–∂–µ —è —Å–∞–º–∞ –Ω–µ –Ω—Ä–∞–≤–ª—é—Å—å' },
    { it: 'Non dire je t‚Äôaime', ru: '–ù–µ –≥–æ–≤–æ—Ä–∏ ¬´je t‚Äôaime¬ª' },
    { it: 'Dimmelo se', ru: '–°–∫–∞–∂–∏ –º–Ω–µ, –µ—Å–ª–∏' },
    { it: 'Ci√≤ che provi √® solo febbre', ru: '–¢–æ, —á—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å ‚Äî –≤—Å–µ–≥–æ –ª–∏—à—å –ª–∏—Ö–æ—Ä–∞–¥–∫–∞' },
    { it: 'Che sale e scende', ru: '–ö–æ—Ç–æ—Ä–∞—è –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –∏ —Å–ø–∞–¥–∞–µ—Ç' },
    { it: 'Che mi fa male, male', ru: '–ö–æ—Ç–æ—Ä–∞—è –¥–µ–ª–∞–µ—Ç –º–Ω–µ –±–æ–ª—å–Ω–æ, –±–æ–ª—å–Ω–æ' },
    { it: 'I tuoi occhi blu Klein', ru: '–¢–≤–æ–∏ —Å–∏–Ω–∏–µ –≥–ª–∞–∑–∞ –ö–ª—è–π–Ω–∞' },
    { it: 'Dicono che', ru: '–ì–æ–≤–æ—Ä—è—Ç, —á—Ç–æ' },
    { it: 'Stanotte √® solo febbre', ru: '–≠—Ç–æ–π –Ω–æ—á—å—é ‚Äî –≤—Å–µ–≥–æ –ª–∏—à—å –ª–∏—Ö–æ—Ä–∞–¥–∫–∞' },
    { it: 'Che sale e scende', ru: '–ö–æ—Ç–æ—Ä–∞—è –ø—Ä–∏—Ö–æ–¥–∏—Ç –∏ —É—Ö–æ–¥–∏—Ç' },
    { it: 'Tu prendi me', ru: '–¢—ã –±–µ—Ä—ë—à—å –º–µ–Ω—è' },
    { it: 'Come un enfant per strada', ru: '–ö–∞–∫ —Ä–µ–±—ë–Ω–∫–∞ –Ω–∞ —É–ª–∏—Ü–µ' },
    { it: 'In abito da gala', ru: '–í –≤–µ—á–µ—Ä–Ω–µ–º –ø–ª–∞—Ç—å–µ' },
    { it: 'Non ci amer√† la fama', ru: '–°–ª–∞–≤–∞ –Ω–∞—Å –Ω–µ –ø–æ–ª—é–±–∏—Ç' },
    { it: 'Non cambier√† la trama', ru: '–°—é–∂–µ—Ç –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è' },
    { it: 'Mille lune passeranno', ru: '–ü—Ä–æ–π–¥—É—Ç —Ç—ã—Å—è—á–∏ –ª—É–Ω' },
    { it: 'E una ci sar√† per sempre', ru: '–ò –æ–¥–Ω–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞' },
    { it: 'Per te che non vuoi scendere', ru: '–î–ª—è —Ç–µ–±—è, –∫—Ç–æ –Ω–µ —Ö–æ—á–µ—Ç —Å–ø—É—Å–∫–∞—Ç—å—Å—è' },
    { it: 'Come la febbre', ru: '–ö–∞–∫ –ª–∏—Ö–æ—Ä–∞–¥–∫–∞' },
    { it: 'Ti sei preso una parte di me', ru: '–¢—ã –∑–∞–±—Ä–∞–ª —á–∞—Å—Ç—å –º–µ–Ω—è' },
    { it: 'Quella ancora pi√π in fondo dell‚Äôanima', ru: '–¢—É, —á—Ç–æ –µ—â—ë –≥–ª—É–±–∂–µ –≤ –¥—É—à–µ' },
    { it: 'Un sentimento', ru: '–ß—É–≤—Å—Ç–≤–æ' },
    { it: 'Che se si rompe taglia', ru: '–ö–æ—Ç–æ—Ä–æ–µ, –µ—Å–ª–∏ –ª–æ–º–∞–µ—Ç—Å—è, —Ä–µ–∂–µ—Ç' },
    { it: 'Come il vetro', ru: '–ö–∞–∫ —Å—Ç–µ–∫–ª–æ' },
    { it: 'Corro, corro come dentro un bosco', ru: '–Ø –±–µ–≥—É, –±–µ–≥—É, –∫–∞–∫ –ø–æ –ª–µ—Å—É' },
    { it: 'Dentro questo inferno √® pi√π difficile', ru: '–í —ç—Ç–æ–º –∞–¥—É –≤—Å—ë —Å–ª–æ–∂–Ω–µ–µ' },
    { it: 'Questo amore dimmi quanto costa', ru: '–°–∫–∞–∂–∏, —Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —ç—Ç–∞ –ª—é–±–æ–≤—å' },
    { it: 'Ti senti un‚Äôombra qua vicino a me', ru: '–¢—ã —á—É–≤—Å—Ç–≤—É–µ—à—å —Å–µ–±—è —Ç–µ–Ω—å—é —Ä—è–¥–æ–º —Å–æ –º–Ω–æ–π' },
    { it: 'Non ascolti quando grido', ru: '–¢—ã –Ω–µ —Å–ª—ã—à–∏—à—å, –∫–æ–≥–¥–∞ —è –∫—Ä–∏—á—É' },
    { it: 'E nemmeno se taccio', ru: '–î–∞–∂–µ –∫–æ–≥–¥–∞ —è –º–æ–ª—á—É' },
    { it: 'Non ascolti quando grido', ru: '–¢—ã –Ω–µ —Å–ª—ã—à–∏—à—å, –∫–æ–≥–¥–∞ —è –∫—Ä–∏—á—É' },
    { it: 'Non dire je t‚Äôaime', ru: '–ù–µ –≥–æ–≤–æ—Ä–∏ ¬´je t‚Äôaime¬ª' },
    { it: 'Dimmelo se', ru: '–°–∫–∞–∂–∏ –º–Ω–µ, –µ—Å–ª–∏' },
    { it: 'Ci√≤ che provi √® solo febbre', ru: '–¢–æ, —á—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å ‚Äî –≤—Å–µ–≥–æ –ª–∏—à—å –ª–∏—Ö–æ—Ä–∞–¥–∫–∞' },
    { it: 'Che sale e scende', ru: '–ö–æ—Ç–æ—Ä–∞—è –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –∏ —Å–ø–∞–¥–∞–µ—Ç' },
    { it: 'Che mi fa male, male', ru: '–ö–æ—Ç–æ—Ä–æ–µ –¥–µ–ª–∞–µ—Ç –º–Ω–µ –±–æ–ª—å–Ω–æ, –±–æ–ª—å–Ω–æ' },
    { it: 'I tuoi occhi blu Klein', ru: '–¢–≤–æ–∏ —Å–∏–Ω–∏–µ –≥–ª–∞–∑–∞ –ö–ª—è–π–Ω–∞' },
    { it: 'Dicono che', ru: '–ì–æ–≤–æ—Ä—è—Ç, —á—Ç–æ' },
    { it: 'Stanotte √® solo febbre', ru: '–≠—Ç–æ–π –Ω–æ—á—å—é ‚Äî –≤—Å–µ–≥–æ –ª–∏—à—å –ª–∏—Ö–æ—Ä–∞–¥–∫–∞' },
    { it: 'Che sale e scende', ru: '–ö–æ—Ç–æ—Ä–∞—è –ø—Ä–∏—Ö–æ–¥–∏—Ç –∏ —É—Ö–æ–¥–∏—Ç' },
    { it: 'Tu prendi me', ru: '–¢—ã –±–µ—Ä—ë—à—å –º–µ–Ω—è' },
    { it: 'Come un enfant per strada', ru: '–ö–∞–∫ —Ä–µ–±—ë–Ω–∫–∞ –Ω–∞ —É–ª–∏—Ü–µ' },
    { it: 'In abito da gala', ru: '–í –≤–µ—á–µ—Ä–Ω–µ–º –ø–ª–∞—Ç—å–µ' },
    { it: 'Non ci amer√† la fama', ru: '–°–ª–∞–≤–∞ –Ω–∞—Å –Ω–µ –ø–æ–ª—é–±–∏—Ç' },
    { it: 'Non cambier√† la trama', ru: '–°—é–∂–µ—Ç –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è' },
    { it: 'Mille lune passeranno', ru: '–ü—Ä–æ–π–¥—É—Ç —Ç—ã—Å—è—á–∏ –ª—É–Ω' },
    { it: 'E una ci sar√† per sempre', ru: '–ò –æ–¥–Ω–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞' },
    { it: 'Per te che non vuoi scendere‚Ä¶', ru: '–î–ª—è —Ç–µ–±—è, –∫—Ç–æ –Ω–µ —Ö–æ—á–µ—Ç —Å–ø—É—Å–∫–∞—Ç—å—Å—è‚Ä¶' },
    { it: 'Non dire je t‚Äôaime', ru: '–ù–µ –≥–æ–≤–æ—Ä–∏ ¬´je t‚Äôaime¬ª' },
    { it: 'Dimmelo se', ru: '–°–∫–∞–∂–∏ –º–Ω–µ, –µ—Å–ª–∏' },
    { it: 'Ci√≤ che provi √® solo febbre', ru: '–¢–æ, —á—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å ‚Äî –≤—Å–µ–≥–æ –ª–∏—à—å –ª–∏—Ö–æ—Ä–∞–¥–∫–∞' },
    { it: 'Che sale e scende', ru: '–ö–æ—Ç–æ—Ä–∞—è –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –∏ —Å–ø–∞–¥–∞–µ—Ç' },
    { it: 'Che mi fa male, male', ru: '–ö–æ—Ç–æ—Ä–∞—è –¥–µ–ª–∞–µ—Ç –º–Ω–µ –±–æ–ª—å–Ω–æ, –±–æ–ª—å–Ω–æ' },
    { it: 'I tuoi occhi blu Klein', ru: '–¢–≤–æ–∏ —Å–∏–Ω–∏–µ –≥–ª–∞–∑–∞ –ö–ª—è–π–Ω–∞' },
    { it: 'Dicono che', ru: '–ì–æ–≤–æ—Ä—è—Ç, —á—Ç–æ' },
    { it: 'Stanotte √® solo febbre', ru: '–≠—Ç–æ–π –Ω–æ—á—å—é ‚Äî –≤—Å–µ–≥–æ –ª–∏—à—å –ª–∏—Ö–æ—Ä–∞–¥–∫–∞' },
    { it: 'Che poi ti prende‚Ä¶', ru: '–ö–æ—Ç–æ—Ä–∞—è –ø–æ—Ç–æ–º –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–±—è‚Ä¶' },
    { it: 'Come la febbre', ru: '–ö–∞–∫ –ª–∏—Ö–æ—Ä–∞–¥–∫–∞' },
    { it: 'Come un enfant per strada', ru: '–ö–∞–∫ —Ä–µ–±—ë–Ω–æ–∫ –Ω–∞ —É–ª–∏—Ü–µ' },
    { it: 'In abito da gala', ru: '–í –≤–µ—á–µ—Ä–Ω–µ–º –ø–ª–∞—Ç—å–µ' },
    { it: 'Non ci amer√† la fama', ru: '–°–ª–∞–≤–∞ –Ω–∞—Å –Ω–µ –ø–æ–ª—é–±–∏—Ç' },
    { it: 'Non cambier√† la trama', ru: '–°—é–∂–µ—Ç –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è' },
    { it: 'Mille lune passeranno', ru: '–ü—Ä–æ–π–¥—É—Ç —Ç—ã—Å—è—á–∏ –ª—É–Ω' },
    { it: 'E una ci sar√† per sempre', ru: '–ò –æ–¥–Ω–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞' },
    { it: 'Per te che non vuoi scendere', ru: '–î–ª—è —Ç–µ–±—è, –∫—Ç–æ –Ω–µ —Ö–æ—á–µ—Ç —Å–ø—É—Å–∫–∞—Ç—å—Å—è' },
    { it: 'Come la febbre', ru: '–ö–∞–∫ –ª–∏—Ö–æ—Ä–∞–¥–∫–∞' }
  ];

  const YADISK_PUBLIC_LINK = 'https://disk.yandex.ru/i/qi3_JYRI_IBLeg';

  function markNeedDownload(need) {
    const btn = document.getElementById("downloadBtn");
    const hint = document.getElementById("downloadHint");
    if (!btn || !hint) return;
    if (need) {
      btn.classList.add("highlight");
      hint.classList.add("warnText");
      hint.textContent = "–§–∞–π–ª –º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å —Å –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–∞ (febbre.mp4 –Ω–µ –Ω–∞–π–¥–µ–Ω —Ä—è–¥–æ–º)";
    } else {
      btn.classList.remove("highlight");
      hint.classList.remove("warnText");
      hint.textContent = "–§–∞–π–ª –º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å —Å –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–∞";
    }
  }

  function openDownloadInNewWindow() {
    window.open(YADISK_PUBLIC_LINK, "_blank", "noopener,noreferrer");
  }

  const vid = document.getElementById("vid");
  const nowEl = document.getElementById("now");
  const fileLabel = document.getElementById("fileLabel");
  const srcLabel = document.getElementById("srcLabel");
  const srcLamp = document.getElementById("srcLamp");
  const filePick = document.getElementById("filePick");
  const videoDock = document.getElementById("videoDock");
  const videoDockSentinel = document.getElementById("videoDockSentinel");

  if (fileLabel && !fileLabel.dataset.fileKey) fileLabel.dataset.fileKey = "febbre.mp4";

  function setSourceUi(kind) {
    if (srcLabel) {
      if (kind === "local") srcLabel.textContent = "–ª–æ–∫–∞–ª—å–Ω—ã–π (–≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª)";
      else if (kind === "server") srcLabel.textContent = "—Å–µ—Ä–≤–µ—Ä (–∏–Ω—Ç–µ—Ä–Ω–µ—Ç)";
      else srcLabel.textContent = "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
    }
    if (srcLamp) {
      srcLamp.classList.remove("is-red","is-green","is-gray");
      if (kind === "local") srcLamp.classList.add("is-green");
      else if (kind === "server") srcLamp.classList.add("is-red");
      else srcLamp.classList.add("is-gray");
    }
  }
  setSourceUi("server");

  function isPortraitMobile() {
    return window.matchMedia("(max-width: 980px) and (orientation: portrait)").matches;
  }

  function undockVideo() {
    if (!videoDock || !videoDockSentinel) return;
    videoDock.classList.remove("isDocked");
    videoDockSentinel.style.height = "0px";
  }

  function dockVideo() {
    if (!videoDock || !videoDockSentinel) return;
    if (videoDock.classList.contains("isDocked")) return;
    const h = videoDock.getBoundingClientRect().height;
    videoDockSentinel.style.height = `${Math.ceil(h)}px`;
    videoDock.classList.add("isDocked");
  }

  function updateVideoDock() {
    if (!videoDock || !videoDockSentinel) return;
    if (!isPortraitMobile()) { undockVideo(); return; }
    const r = videoDockSentinel.getBoundingClientRect();
    const shouldDock = r.top <= 0;
    if (shouldDock) dockVideo(); else undockVideo();
  }

  window.addEventListener("scroll", updateVideoDock, { passive: true });
  window.addEventListener("resize", () => {
    if (videoDock && videoDock.classList.contains("isDocked")) {
      const h = videoDock.getBoundingClientRect().height;
      if (videoDockSentinel) videoDockSentinel.style.height = `${Math.ceil(h)}px`;
    }
    updateVideoDock();
  }, { passive: true });

  let uiTimer = null;
  let segTimer = null;

  function startTicker() {
    if (uiTimer) clearInterval(uiTimer);
    uiTimer = setInterval(() => {
      nowEl.textContent = (vid.currentTime || 0).toFixed(2);
    }, 120);
  }
  startTicker();

  function stopSegmentPlayback() {
    if (segTimer) clearInterval(segTimer);
    segTimer = null;
  }

  function playSegment(start, end) {
    const s = Number(start), e = Number(end);
    if (!Number.isFinite(s) || !Number.isFinite(e) || e <= s) {
      alert("–ü—Ä–æ–≤–µ—Ä—å —Ç–∞–π–º–∫–æ–¥—ã: start –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å < end (–∏ –æ–±–∞ —á–∏—Å–ª–∞).");
      return;
    }
    stopSegmentPlayback();
    vid.currentTime = Math.max(0, s);
    const playPromise = vid.play();
    if (playPromise && typeof playPromise.catch === "function") playPromise.catch(() => {});
    segTimer = setInterval(() => {
      if ((vid.currentTime || 0) >= e - 0.03) {
        vid.pause();
        stopSegmentPlayback();
      }
    }, 40);
  }

  document.getElementById("stop").onclick = () => {
    vid.pause();
    stopSegmentPlayback();
  };

  const downloadBtn = document.getElementById("downloadBtn");
  if (downloadBtn) downloadBtn.onclick = openDownloadInNewWindow;

  (function autoDetectDefaultFile() {
    if (filePick && filePick.files && filePick.files.length) return;

    const onMeta = () => { markNeedDownload(false); cleanup(); };
    const onErr  = () => { markNeedDownload(true); cleanup(); };

    function cleanup(){
      vid.removeEventListener("loadedmetadata", onMeta);
      vid.removeEventListener("error", onErr);
    }

    vid.addEventListener("loadedmetadata", onMeta);
    vid.addEventListener("error", onErr);

    try { vid.load(); } catch {}
  })();

  function storageKey\(\) \{
    const name = \(fileLabel\.dataset\.fileKey \|\| "febbre\.mp4"\);
    return `febbre_segments_local_\$\{name\}`;
  \}

  function phoneticKey() {
    const name = (fileLabel.dataset.fileKey || "febbre.mp4");
    return `febbre_phonetic_local_${name}`;
  }

  function loadPhonetic() {
    try { return JSON.parse(localStorage.getItem(phoneticKey()) || "[]"); }
    catch { return []; }
  }

  function savePhonetic(arr) {
    localStorage.setItem(phoneticKey(), JSON.stringify(arr));
  }

  let phoneticUser = loadPhonetic();

  function normalizePhoneticInPlace() {
    if (!Array.isArray(phoneticUser)) phoneticUser = [];
    for (let i = 0; i < LINES.length; i++) {
      if (typeof phoneticUser[i] !== "string") phoneticUser[i] = "";
    }
  }

  function loadSegments() {
    try { return JSON.parse(localStorage.getItem(storageKey()) || "[]"); }
    catch { return []; }
  }

  function saveSegments(arr) {
    localStorage.setItem(storageKey(), JSON.stringify(arr));
  }

  let segments = loadSegments();

  function normalizeSegmentsInPlace() {
    if (!Array.isArray(segments)) segments = [];
    for (let i = 0; i < LINES.length; i++) {
      if (!segments[i]) segments[i] = { start: null, end: null, learned: false };
      if (typeof segments[i].learned !== "boolean") segments[i].learned = false;

      const s = segments[i].start;
      const e = segments[i].end;
      segments[i].start = (Number.isFinite(Number(s)) ? Number(s) : null);
      segments[i].end   = (Number.isFinite(Number(e)) ? Number(e) : null);
    }
  }

  function importFromObject(obj, { silent = false } = {}) {
    if (!obj) throw new Error("–ü—É—Å—Ç–æ–π JSON");

    // –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç (–∫–∞–∫ store-hav.json): { version, song, ui, items:[{text,translation,phonetic,start,end,learned}] }
    if (obj.song && Array.isArray(obj.items)) {
      const incomingItems = obj.items;

      segments = incomingItems.slice(0, LINES.length).map(it => ({
        start: (Number.isFinite(Number(it.start)) ? Number(it.start) : null),
        end:   (Number.isFinite(Number(it.end)) ? Number(it.end) : null),
        learned: (typeof it.learned === "boolean" ? it.learned : false)
      }));
      normalizeSegmentsInPlace();
      saveSegments(segments);

      phoneticUser = incomingItems.slice(0, LINES.length).map(it => String(it.phonetic || it.phonetic_user || ""));
      normalizePhoneticInPlace();
      savePhonetic(phoneticUser);

      if (!silent) alert("–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç)");
      return;
    }

    // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç: { segments:[...] } –∏–ª–∏ –º–∞—Å—Å–∏–≤
    const incoming = Array.isArray(obj) ? obj : obj.segments;
    if (!Array.isArray(incoming)) throw new Error("–í JSON –Ω–µ—Ç –º–∞—Å—Å–∏–≤–∞ items (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç) –∏–ª–∏ segments (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç)");

    segments = incoming.slice(0, LINES.length);
    normalizeSegmentsInPlace();
    saveSegments(segments);

    normalizePhoneticInPlace();
    savePhonetic(phoneticUser);

    if (!silent) alert("–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ");
  }

  // –í–ê–ñ–ù–û: –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –∫–∞–∂–¥–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏,
  // –µ—Å–ª–∏ febbre.json –¥–æ—Å—Ç—É–ø–µ–Ω. –ù–∏–∫–∞–∫–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ "—É–∂–µ –µ—Å—Ç—å" –∏ —Ç.–ø.
  async function forceSyncFromFebbreJson() {
    // –ò—â–µ–º JSON –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö, –ø–æ—Ç–æ–º—É —á—Ç–æ Febbre —Ç–µ–ø–µ—Ä—å –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –º–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–≥–æ —Å–∞–π—Ç–∞
    const candidates = [
      "../../data/songs/febbre.json",   // songs/febbre/index.html -> data/songs/febbre.json
      "../data/songs/febbre.json",
      "data/songs/febbre.json",
      "febbre.json"                    // fallback: —Ä—è–¥–æ–º
    ];

    for (const rel of candidates) {
      try {
        const url = new URL(rel, location.href);
        url.searchParams.set("cb", String(Date.now())); // cache-bust

        const res = await fetch(url.toString(), { cache: "no-store" });
        if (!res.ok) continue;

        const obj = await res.json();
        importFromObject(obj, { silent: true });
        return true;
      } catch (e) {
        console.warn("[FEBBRE] JSON –Ω–µ –ø—Ä–∏–º–µ–Ω—ë–Ω –∏–∑", rel, e);
      }
    }
    return false;
  }

  const rowsEl = document.getElementById("rows");
  let showLearned = true;

  function fmt(v) {
    if (v === null || v === undefined || v === "") return "";
    const n = Number(v);
    return Number.isFinite(n) ? n.toFixed(2) : "";
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function renderRows() {
    normalizePhoneticInPlace();
    rowsEl.innerHTML = "";

    LINES.forEach((line, i) => {
      const seg = segments[i];
      if (!showLearned && seg.learned) return;

      const row = document.createElement("div");
      row.className = "row";
      if (seg.learned) row.classList.add("muted");

      row.innerHTML = `
        <div class="it">${escapeHtml(line.it)}</div>
        <div class="ru">${escapeHtml(line.ru)}</div>

        <div class="controls">
          <button class="warn" data-act="play">‚ñ∂Ô∏è –§—Ä–∞–≥–º–µ–Ω—Ç</button>
          <button class="ghost" data-act="toggleRu">–ü–µ—Ä–µ–≤–æ–¥</button>

          <span class="mini">üëÇ –∫–∞–∫ —Å–ª—ã—à–∞–ª</span>
          <input type="text" data-field="phonetic" placeholder="–≤–ø–∏—à–∏ –∫–∞–∫ —É—Å–ª—ã—à–∞–ª‚Ä¶" value="${escapeHtml(phoneticUser[i] || "")}" style="flex:1 1 220px; min-width: 180px;" />

          <span class="mini">start</span>
          <input type="number" step="0.01" inputmode="decimal" data-field="start" value="${fmt(seg.start)}" />
          <button class="ghost" data-act="setStart">‚è± start=—Ç–µ–∫—É—â–µ–µ</button>

          <span class="mini">end</span>
          <input type="number" step="0.01" inputmode="decimal" data-field="end" value="${fmt(seg.end)}" />
          <button class="ghost" data-act="setEnd">‚è± end=—Ç–µ–∫—É—â–µ–µ</button>

          <button class="good" data-act="learned">${seg.learned ? "–í–µ—Ä–Ω—É—Ç—å –≤ –ø–æ–≤—Ç–æ—Ä" : "–í—ã—É—á–µ–Ω–æ"}</button>
        </div>
      `;

      const ruEl = row.querySelector(".ru");
      const startInput = row\.querySelector\('input\[data-field=\"start\"\]'\);
      const endInput = row\.querySelector\('input\[data-field=\"end\"\]'\);
      const phonInput = row.querySelector('input[data-field="phonetic"]');

      row.querySelector('[data-act="toggleRu"]').onclick = () => {
        ruEl.style.display = (ruEl.style.display === "block") ? "none" : "block";
      };

      row.querySelector('[data-act="setStart"]').onclick = () => {
        const t = vid.currentTime || 0;
        startInput.value = t.toFixed(2);
        segments[i].start = Number(startInput.value);
        saveSegments(segments);
      };

      row.querySelector('[data-act="setEnd"]').onclick = () => {
        const t = vid.currentTime || 0;
        endInput.value = t.toFixed(2);
        segments[i].end = Number(endInput.value);
        saveSegments(segments);
      };

      row.querySelector('[data-act="play"]').onclick = () => {
        const s = Number(startInput.value);
        const e = Number(endInput.value);
        segments[i].start = Number.isFinite(s) ? s : null;
        segments[i].end = Number.isFinite(e) ? e : null;
        saveSegments(segments);
        playSegment(segments[i].start, segments[i].end);
      };

      row.querySelector('[data-act="learned"]').onclick = () => {
        segments[i].learned = !segments[i].learned;
        saveSegments(segments);
        renderRows();
      };

      startInput.addEventListener("change", () => {
        const v = Number(startInput.value);
        segments[i].start = Number.isFinite(v) ? v : null;
        saveSegments(segments);
      });

      endInput.addEventListener\("change", \(\) => \{
        const v = Number\(endInput.value\);
        segments\[i\].end = Number.isFinite\(v\) \? v : null;
        saveSegments\(segments\);
      \}\);

      phonInput.addEventListener("change", () => {
        phoneticUser[i] = String(phonInput.value || "");
        savePhonetic(phoneticUser);
      });

      rowsEl.appendChild(row);
    });
  }

  (async function boot() {
    // 1) –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–ª–∏—Ç—å —Å–µ–≥–º–µ–Ω—Ç—ã –∏–∑ febbre.json
    const synced = await forceSyncFromFebbreJson();

    // 2) –ë–µ—Ä—ë–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã –∏–∑ localStorage (–ø–æ—Å–ª–µ sync) –∏–ª–∏ —Å—Ç–∞—Ä—ã–µ (–µ—Å–ª–∏ sync –Ω–µ –≤—ã—à–µ–ª)
    segments = loadSegments();
    phoneticUser = loadPhonetic();
    normalizeSegmentsInPlace();
    normalizePhoneticInPlace();
    renderRows();

    // 3) –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∏–º docking (–Ω–∞ —Å–ª—É—á–∞–π –≤—Ö–æ–¥–∞ –Ω–µ —Å–≤–µ—Ä—Ö—É)
    updateVideoDock();

    if (synced) console.info("[FEBBRE] –°–µ–≥–º–µ–Ω—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ febbre.json (force).");
  })();

  filePick.addEventListener("change", () => {
    const f = filePick.files && filePick.files[0];
    if (!f) return;

    fileLabel.textContent = f.name;
    fileLabel.dataset.fileKey = f.name;

    segments = loadSegments();
    phoneticUser = loadPhonetic();
    normalizeSegmentsInPlace();
    normalizePhoneticInPlace();
    renderRows();

    const url = URL.createObjectURL(f);
    vid.src = url;
    vid.load();

    setSourceUi("local");
  });

  document.getElementById("useDefault").onclick = async () => {
    fileLabel.textContent = "febbre.mp4";
    fileLabel.dataset.fileKey = "febbre.mp4";

    vid.src = "febbre.mp4";
    vid.load();
    setSourceUi("server");

    // –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –∫ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–º—É —Ñ–∞–π–ª—É —Ç–æ–∂–µ —Ñ–æ—Ä—Å–∏–º sync
    await forceSyncFromFebbreJson();

    segments = loadSegments();
    phoneticUser = loadPhonetic();
    normalizeSegmentsInPlace();
    normalizePhoneticInPlace();
    renderRows();
  };

  document.getElementById("saveAll").onclick = () => {
    saveSegments(segments);
    alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ");
  };

  let ruShownAll = false;
  document.getElementById("toggleRuAll").onclick = () => {
    ruShownAll = !ruShownAll;
    document.querySelectorAll(".ru").forEach(el => el.style.display = ruShownAll ? "block" : "none");
  };

  document.getElementById("toggleLearned").onclick = () => {
    showLearned = !showLearned;
    document.getElementById("toggleLearned").textContent = showLearned ? "–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –≤—ã—É—á–µ–Ω–Ω—ã–µ" : "–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—ã—É—á–µ–Ω–Ω—ã–µ: –ù–ï–¢";
    renderRows();
  };

  document.getElementById("resetTimes").onclick = () => {
    if (!confirm("–°–±—Ä–æ—Å–∏—Ç—å start/end –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫?")) return;
    segments = segments.map(s => ({...s, start: null, end: null}));
    saveSegments(segments);
    renderRows();
  };

  document.getElementById("copyNow").onclick = async () => {
    const t = (vid.currentTime || 0).toFixed(2);
    try {
      await navigator.clipboard.writeText(t);
      alert(`–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: ${t}s`);
    } catch {
      prompt("–°–∫–æ–ø–∏—Ä—É–π –≤—Ä—É—á–Ω—É—é:", t);
    }
  };

  const exportBox = document.getElementById("exportBox");
  const importBox = document.getElementById("importBox");

  const jsonPick = document.getElementById("jsonPick");
  if (jsonPick) {
    jsonPick.addEventListener("change", async () => {
      const f = jsonPick.files && jsonPick.files[0];
      if (!f) return;
      try {
        const txt = await readJsonFile(f);
        importBox.value = txt;
        alert("JSON –∑–∞–≥—Ä—É–∂–µ–Ω –≤ –ø–æ–ª–µ –∏–º–ø–æ—Ä—Ç–∞ ‚úÖ (—Ç–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏ ¬´–ò–º–ø–æ—Ä—Ç¬ª)");
      } catch (e) {
        alert(e.message || "–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è JSON.");
      } finally {
        // —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–±—Ä–∞—Ç—å —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª –≤—Ç–æ—Ä–æ–π —Ä–∞–∑
        jsonPick.value = "";
      }
    });
  }

  document.getElementById("exportBtn").onclick = () => {
    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ –µ–¥–∏–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (–∫–∞–∫ store-hav.json), —á—Ç–æ–±—ã Febbre –±—ã–ª –∫–∞—Ç–∞–ª–æ–≥–∏–∑–∏—Ä—É–µ–º—ã–º
    const items = LINES.map((x, i) => ({
      id: `fb-${String(i+1).padStart(3,"0")}`,
      text: x.it,
      translation: x.ru,
      phonetic: phoneticUser[i] || "",
      why: "",
      confidence: null,
      start: segments[i]?.start ?? null,
      end: segments[i]?.end ?? null,
      learned: !!segments[i]?.learned
    }));

    const payload = {
      version: 1,
      song: {
        id: "febbre",
        title: "Febbre",
        artist: "Clara",
        language: "it",
        languageName: "Italiano",
        hint: "–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å mp3 –∏–ª–∏ mp4. –ü–æ–ª–æ–∂–∏ —Ñ–∞–π–ª —Ä—è–¥–æ–º —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π –ø–µ—Å–Ω–∏ –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ ¬´–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª¬ª.",
        media: { src: (fileLabel.dataset.fileKey || "febbre.mp4") }
      },
      ui: {
        showTranslationByDefault: true,
        showPhoneticByDefault: false,
        showWhyHeardByDefault: false
      },
      items
    };

    exportBox.value = JSON.stringify(payload, null, 2);
  };

  document.getElementById("copyExport").onclick = async () => {
    if (!exportBox.value.trim()) {
      alert("–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ ¬´–≠–∫—Å–ø–æ—Ä—Ç¬ª.");
      return;
    }
    try {
      await navigator.clipboard.writeText(exportBox.value);
      alert("JSON —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω ‚úÖ");
    } catch {
      prompt("–°–∫–æ–ø–∏—Ä—É–π –≤—Ä—É—á–Ω—É—é:", exportBox.value);
    }
  };


  function sanitizeJsonText(text) {
    // 1) —É–±–∏—Ä–∞–µ–º BOM + –ø—Ä–æ–±–µ–ª—ã
    let t = String(text ?? "").replace(/^\uFEFF/, "").trim();

    // 2) –µ—Å–ª–∏ –≤—Å—Ç–∞–≤–∏–ª–∏ –∫–æ–¥-–±–ª–æ–∫ ```json ... ```
    if (t.startsWith("```")) {
      t = t.replace(/^```[a-zA-Z0-9_-]*\s*/,"").replace(/```$/,"").trim();
    }

    // 3) —á–∞—Å—Ç–æ –∫–æ–ø–∏—Ä—É—é—Ç —Å –ª–∏—à–Ω–∏–º —Ç–µ–∫—Å—Ç–æ–º –¥–æ/–ø–æ—Å–ª–µ ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º –≤—ã—Ç–∞—â–∏—Ç—å –ø–µ—Ä–≤—ã–π JSON-–æ–±—ä–µ–∫—Ç/–º–∞—Å—Å–∏–≤
    const firstObj = t.indexOf("{");
    const firstArr = t.indexOf("[");
    let start = -1;
    if (firstObj === -1) start = firstArr;
    else if (firstArr === -1) start = firstObj;
    else start = Math.min(firstObj, firstArr);

    if (start > 0) t = t.slice(start).trim();

    // 4) –æ–±—Ä–µ–∂–µ–º —Ö–≤–æ—Å—Ç –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–∫—Ä—ã–≤–∞—é—â–µ–π —Å–∫–æ–±–∫–∏
    const lastObj = t.lastIndexOf("}");
    const lastArr = t.lastIndexOf("]");
    const end = Math.max(lastObj, lastArr);
    if (end !== -1 && end < t.length - 1) t = t.slice(0, end + 1).trim();

    return t;
  }

  async function readJsonFile(file) {
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onerror = () => reject(new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª JSON"));
      fr.onload = () => resolve(String(fr.result || ""));
      fr.readAsText(file, "utf-8");
    });
  }

  document.getElementById("importBtn").onclick = () => {
    let obj;
    const raw = sanitizeJsonText(importBox.value);
    try { obj = JSON.parse(raw); }
    catch (e) {
      console.warn("[FEBBRE] JSON.parse error:", e, "raw:", raw.slice(0, 500));
      alert("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å JSON. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –≤—Å—Ç–∞–≤–ª–µ–Ω —á–∏—Å—Ç—ã–π JSON –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ (–∏–ª–∏ –≤—ã–±–µ—Ä–∏ —Ñ–∞–π–ª .json).\n\n–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏: " + (e.message || e));
      return;
    }

    try {
      importFromObject(obj, { silent: false });
      renderRows();
    } catch (e) {
      alert(e.message || "–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞.");
    }
  };

  // Focus-mode: –ø—Ä—è—á–µ–º #pageHeader –≤ mobile landscape, –∫–æ–≥–¥–∞ —Å–∫—Ä–æ–ª–ª—è—Ç —Ñ—Ä–∞–∑—ã
  const phrasesPanel = document.getElementById("phrasesPanel");

  function isLandscapeMobile() {
    return window.matchMedia("(max-width: 980px) and (orientation: landscape)").matches;
  }

  function setFocusMode(on) {
    document.body.classList.toggle("isFocusMode", !!on);
  }

  if (phrasesPanel) {
    phrasesPanel.addEventListener("scroll", () => {
      if (!isLandscapeMobile()) return;
      setFocusMode(phrasesPanel.scrollTop > 8);
    }, { passive: true });
  }

  window.addEventListener("resize", () => {
    if (!isLandscapeMobile()) setFocusMode(false);
  }, { passive: true });
</script>

  <div class="panel" style="margin-top:14px;">
    <h2 style="margin:0 0 8px; font-size:16px; color:#eaeaf0;">üíú –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</h2>
    <div class="mini" style="margin-bottom:10px;">
      –î–æ–Ω–∞—Ç –¥–æ–±—Ä–æ–≤–æ–ª—å–Ω—ã–π –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø–æ–∫—É–ø–∫–æ–π —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ —É—Å–ª—É–≥–∏.
    </div>
    <div class="topbar" style="margin-bottom:0;">
      <!-- –ó–∞–º–µ–Ω–∏—Ç–µ href –Ω–∞ –≤–∞—à–∏ —Ä–µ–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –æ–ø–ª–∞—Ç—ã -->
            <a class="donateLink" href="https://donatty.com/serebrjakovmaratserebrjakov" id="donateDonatty" rel="noopener" style="text-decoration:none">
        <button class="ghost" type="button">Donatty.com</button>
      </a>
            <a class="donateLink" href="https://donate.stream/yoomoney4100119460320153" id="donateYooMoney" rel="noopener" style="text-decoration:none">
        <button class="ghost" type="button">–ÆMoney</button>
          </a>


      <span class="mini" id="donateHint"></span>
    </div>
  </div>

  <script>
    // –ü–æ–¥—Å–∫–∞–∑–∫–∞, –µ—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
    (function () {
      const hint = document.getElementById("donateHint");
      const a1 = document.getElementById("donateDonatty");
      const a2 = document.getElementById("donateYooMoney");
      const notSet = [a1, a2].some(a => !a || !a.getAttribute("href") || a.getAttribute("href") === "#");
      if (hint && notSet) {
        hint.textContent = "–ê–¥–º–∏–Ω—É: –≤—Å—Ç–∞–≤—å—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –≤ href (—Å–µ–π—á–∞—Å —Å—Ç–æ—è—Ç –∑–∞–≥–ª—É—à–∫–∏).";
      }
      // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–ª–∞—Ç–µ–∂–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–µ (–±–µ–∑ –Ω–æ–≤—ã—Ö –æ–∫–æ–Ω)
      [a1, a2].forEach(a => { if (a) a.target = "_self"; });
    })();
  </script>


</body>
</html>
